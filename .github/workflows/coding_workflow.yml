name: Coding Agent Workflow

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - list_tasks
          - validate
          - check_practices
          - generate_codex_task
      spec_name:
        description: 'Specification name (required for list_tasks and generate_codex_task)'
        required: false
        type: string
      task_id:
        description: 'Task ID (required for generate_codex_task)'
        required: false
        type: string
  
  # Triggered when specifications are approved (updated in main)
  push:
    paths:
      - 'docs/specifications/*.yaml'
    branches:
      - main

jobs:
  # Job 1: Validate prerequisites before decomposition/codex tasks
  validate_prerequisites:
    name: Validate Prerequisites
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (inputs.action == 'list_tasks' || inputs.action == 'generate_codex_task')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate Step 2b capability specification exists
        if: inputs.spec_name != ''
        run: |
          SPEC_FILE="docs/specifications/${{ inputs.spec_name }}.yaml"
          
          if [ ! -f "$SPEC_FILE" ]; then
            echo "❌ ERROR: Capability specification not found: $SPEC_FILE"
            echo ""
            echo "You must complete Step 2b (Capability Planning) before Step 3/4"
            echo "Run: Actions → Capability Planner Agent Workflow → Run workflow"
            exit 1
          fi
          
          echo "✓ Capability specification found: $SPEC_FILE"
      
      - name: Approval gate reminder
        if: inputs.action == 'generate_codex_task'
        run: |
          echo ""
          echo "════════════════════════════════════════════════════════"
          echo "⚠️  PREREQUISITE CHECK"
          echo "════════════════════════════════════════════════════════"
          echo ""
          echo "Before generating Codex tasks, confirm that:"
          echo "  ✓ Step 1 (Objective) is approved"
          echo "  ✓ Step 2a (Pipeline Plan) is approved"
          echo "  ✓ Step 2b (Capability Spec) is approved"
          echo "  ✓ Step 3 (Decomposition) is complete"
          echo ""
          echo "════════════════════════════════════════════════════════"
  
  coding_agent:
    runs-on: ubuntu-latest
    needs: [validate_prerequisites]
    if: |
      always() &&
      (needs.validate_prerequisites.result == 'success' || 
       needs.validate_prerequisites.result == 'skipped')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml
      
      - name: List coding tasks
        if: github.event_name == 'workflow_dispatch' && inputs.action == 'list_tasks'
        run: |
          if [ -z "${{ inputs.spec_name }}" ]; then
            echo "Error: spec_name is required for list_tasks action"
            exit 1
          fi
          python tools/coding_agent.py tasks "${{ inputs.spec_name }}"
      
      - name: Validate repository
        if: github.event_name == 'workflow_dispatch' && inputs.action == 'validate'
        run: python tools/coding_agent.py validate
      
      - name: Check best practices
        if: github.event_name == 'workflow_dispatch' && inputs.action == 'check_practices'
        run: python tools/coding_agent.py check
      
      - name: Generate Codex task
        if: github.event_name == 'workflow_dispatch' && inputs.action == 'generate_codex_task'
        run: |
          if [ -z "${{ inputs.spec_name }}" ] || [ -z "${{ inputs.task_id }}" ]; then
            echo "Error: spec_name and task_id are required for generate_codex_task action"
            exit 1
          fi
          python tools/coding_agent.py codex-task "${{ inputs.spec_name }}" "${{ inputs.task_id }}"
      
      - name: Auto-validate on specification changes
        if: github.event_name == 'push'
        run: |
          echo "Specification updated, running validation..."
          python tools/coding_agent.py validate
      
      - name: List updated specifications
        if: github.event_name == 'push'
        run: |
          echo ""
          echo "Updated specifications:"
          git diff --name-only HEAD~1 HEAD | grep 'docs/specifications/' || echo "None"
          echo ""
          echo "To start coding:"
          echo "1. Review the specification changes"
          echo "2. Use 'Coding Agent Workflow' to list tasks"
          echo "3. Create Codex tasks for implementation"
      
      - name: Summary
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo ""
          echo "════════════════════════════════════════════════════════"
          echo "Coding Agent Action Complete: ${{ inputs.action }}"
          echo "════════════════════════════════════════════════════════"
          echo ""
          
          if [ "${{ inputs.action }}" = "list_tasks" ]; then
            echo "STEP 3 GUIDANCE: Decompose into Development Elements"
            echo ""
            echo "Next steps:"
            echo "1. Review the suggested task breakdown above"
            echo "2. Adjust decomposition if needed"
            echo "3. Ensure each element fits in ONE PR"
            echo "4. Proceed to Step 4: generate_codex_task for each element"
            echo ""
          elif [ "${{ inputs.action }}" = "generate_codex_task" ]; then
            echo "STEP 4 COMPLETE: Codex Task Generated"
            echo ""
            echo "Next steps:"
            echo "1. Review the Codex task specification above"
            echo "2. Use it to create a PR (Step 5)"
            echo "3. Ensure all quality gates pass before merge"
            echo ""
          fi
          
          echo "Best Practices Reminders:"
          echo "- Follow DRY (Don't Repeat Yourself) principle"
          echo "- Follow SOLID principles"
          echo "- Run validation before committing"
          echo "- Update documentation as you code"
          echo ""
          echo "════════════════════════════════════════════════════════"
