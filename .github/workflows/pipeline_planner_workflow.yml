name: Pipeline Planner Agent Workflow (Step 2a)

on:
  workflow_dispatch:
    inputs:
      objective_name:
        description: 'Objective name (must match approved Step 1 document)'
        required: true
        type: string
      objective_file:
        description: 'Objective filename (e.g., "vendor_onboarding.md")'
        required: true
        type: string
      overwrite:
        description: 'Overwrite existing pipeline plan if it exists'
        required: false
        type: boolean
        default: false

jobs:
  validate_prerequisites:
    name: Validate Step 1 Prerequisites
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate Step 1 objective exists
        run: |
          OBJECTIVE_FILE="docs/roadmaps/${{ inputs.objective_file }}"
          
          if [ ! -f "$OBJECTIVE_FILE" ]; then
            echo "âŒ ERROR: Step 1 objective document not found: $OBJECTIVE_FILE"
            echo ""
            echo "You must complete Step 1 (Define Objective) before Step 2a"
            echo "Run: Actions â†’ Planner Agent Workflow â†’ Run workflow"
            exit 1
          fi
          
          echo "âœ“ Step 1 objective document found: $OBJECTIVE_FILE"
      
      - name: Check for required sections in objective
        run: |
          OBJECTIVE_FILE="docs/roadmaps/${{ inputs.objective_file }}"
          EXIT_CODE=0
          
          echo "Validating Step 1 document structure..."
          
          if ! grep -q "## Objective Statement" "$OBJECTIVE_FILE"; then
            echo "âŒ Missing 'Objective Statement' section"
            EXIT_CODE=1
          fi
          
          if ! grep -q "## Expected Outcomes" "$OBJECTIVE_FILE"; then
            echo "âŒ Missing 'Expected Outcomes' section"
            EXIT_CODE=1
          fi
          
          if ! grep -q "## Success Criteria" "$OBJECTIVE_FILE"; then
            echo "âŒ Missing 'Success Criteria' section"
            EXIT_CODE=1
          fi
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "âŒ Step 1 objective document is incomplete"
            echo "Please complete all required sections before proceeding to Step 2a"
            exit 1
          fi
          
          echo "âœ“ Step 1 objective document is properly structured"
      
      - name: Approval gate reminder
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸  MANUAL APPROVAL CHECKPOINT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Before proceeding, confirm that:"
          echo "  âœ“ Step 1 objective has been reviewed by stakeholders"
          echo "  âœ“ All stakeholders have approved the objective"
          echo "  âœ“ The objective document is complete and locked"
          echo ""
          echo "If these conditions are NOT met, cancel this workflow"
          echo "and complete the Step 1 approval process first."
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  
  create_pipeline_plan:
    name: Create Pipeline Plan
    runs-on: ubuntu-latest
    needs: validate_prerequisites
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml
      
      - name: Create pipeline plan
        run: |
          if [ "${{ inputs.overwrite }}" = "true" ]; then
            python tools/pipeline_planner_agent.py create "${{ inputs.objective_name }}" \
              --objective-ref "${{ inputs.objective_file }}" \
              --overwrite
          else
            python tools/pipeline_planner_agent.py create "${{ inputs.objective_name }}" \
              --objective-ref "${{ inputs.objective_file }}"
          fi
      
      - name: Validate pipeline plan structure
        run: |
          PIPELINE_FILE="docs/roadmaps/${{ inputs.objective_name }}_pipeline_plan.md"
          
          echo "Validating pipeline plan structure..."
          EXIT_CODE=0
          
          if ! grep -q "## Processing Sequence" "$PIPELINE_FILE"; then
            echo "âš ï¸  Missing 'Processing Sequence' section"
            EXIT_CODE=1
          fi
          
          if ! grep -q "## Conceptual Artifacts" "$PIPELINE_FILE" && ! grep -q "## Artifacts" "$PIPELINE_FILE"; then
            echo "âš ï¸  Missing 'Conceptual Artifacts' or 'Artifacts' section"
            EXIT_CODE=1
          fi
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ“ Pipeline plan structure validated"
          else
            echo "âš ï¸  Pipeline plan missing required sections (please add them)"
          fi
      
      - name: Commit pipeline plan
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/roadmaps/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add pipeline plan for: ${{ inputs.objective_name }} (Step 2a)"
            git push
          fi
      
      - name: Next steps
        run: |
          echo "âœ“ Pipeline plan created successfully!"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "STEP 2a COMPLETE: Pipeline Plan Created"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ MANUAL REVIEW REQUIRED:"
          echo "   This is a MANDATORY checkpoint in the 5-step workflow"
          echo ""
          echo "Required actions before proceeding to Step 2b:"
          echo "1. âœï¸  Edit: docs/roadmaps/${{ inputs.objective_name }}_pipeline_plan.md"
          echo "2. ğŸ“ Fill in all TODO sections with:"
          echo "   - Complete processing sequence"
          echo "   - Decision points and fallback paths"
          echo "   - Conceptual artifacts (by meaning, NOT S3 paths)"
          echo "   - Mapping to existing jobs (if applicable)"
          echo "3. ğŸ‘¥ Review with stakeholders (Tech Lead, Architect)"
          echo "4. âœ… Obtain explicit approval from all stakeholders"
          echo "5. ğŸ”’ Lock the document (mark as approved in commit message)"
          echo ""
          echo "âš ï¸  DO NOT PROCEED to Step 2b without stakeholder approval"
          echo ""
          echo "Once approved, proceed to Step 2b for EACH capability:"
          echo "â†’ Actions â†’ Capability Planner Agent Workflow â†’ Run workflow"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
