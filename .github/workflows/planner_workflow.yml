name: Planner Agent Workflow

on:
  workflow_dispatch:
    inputs:
      phase_name:
        description: 'Planning phase name (e.g., "Q1 2026 Features")'
        required: true
        type: string
      description:
        description: 'Brief description of the planning objective'
        required: false
        type: string
      overwrite:
        description: 'Overwrite existing planning document if it exists'
        required: false
        type: boolean
        default: false

jobs:
  create_planning_document:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml
      
      - name: Create planning document
        id: create_plan
        run: |
          if [ "${{ inputs.overwrite }}" = "true" ]; then
            python tools/planner_agent.py create "${{ inputs.phase_name }}" \
              --description "${{ inputs.description }}" \
              --overwrite
          else
            python tools/planner_agent.py create "${{ inputs.phase_name }}" \
              --description "${{ inputs.description }}"
          fi
      
      - name: Commit planning document
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/roadmaps/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add planning document: ${{ inputs.phase_name }}"
            git push
          fi
      
      - name: List all planning documents
        run: python tools/planner_agent.py list
      
      - name: Validate planning document structure
        run: |
          OBJECTIVE_FILE="docs/roadmaps/${{ inputs.phase_name }}.md"
          
          echo "Validating planning document structure..."
          EXIT_CODE=0
          
          # Check for required sections
          if ! grep -q "## Objective Statement" "$OBJECTIVE_FILE"; then
            echo "âš ï¸  Missing 'Objective Statement' section"
            EXIT_CODE=1
          fi
          
          if ! grep -q "## Expected Outcomes" "$OBJECTIVE_FILE"; then
            echo "âš ï¸  Missing 'Expected Outcomes' section"
            EXIT_CODE=1
          fi
          
          if ! grep -q "## Out-of-Scope" "$OBJECTIVE_FILE"; then
            echo "âš ï¸  Missing 'Out-of-Scope' section"
            EXIT_CODE=1
          fi
          
          if ! grep -q "## Success Criteria" "$OBJECTIVE_FILE"; then
            echo "âš ï¸  Missing 'Success Criteria' section"
            EXIT_CODE=1
          fi
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ“ Planning document structure validated"
          else
            echo "âš ï¸  Planning document missing required sections (please add them)"
          fi
      
      - name: Next steps
        run: |
          echo "âœ“ Planning document created successfully!"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "STEP 1 COMPLETE: Objective Definition Created"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ MANUAL REVIEW REQUIRED:"
          echo "   This is a MANDATORY checkpoint in the 5-step workflow"
          echo ""
          echo "Required actions before proceeding to Step 2a:"
          echo "1. âœï¸  Edit the planning document: docs/roadmaps/${{ inputs.phase_name }}.md"
          echo "2. ğŸ“ Fill in all TODO sections with concrete details"
          echo "3. ğŸ‘¥ Review with stakeholders (Product, Tech Lead, Business)"
          echo "4. âœ… Obtain explicit approval from all stakeholders"
          echo "5. ğŸ”’ Lock the document (mark as approved in commit message)"
          echo ""
          echo "âš ï¸  DO NOT PROCEED to Step 2a without stakeholder approval"
          echo ""
          echo "Once approved, proceed to Step 2a:"
          echo "â†’ Actions â†’ Pipeline Planner Agent Workflow â†’ Run workflow"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
