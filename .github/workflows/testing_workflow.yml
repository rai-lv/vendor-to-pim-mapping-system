name: Testing Agent Workflow

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - run_tests
          - infer_tests
          - list_logs
      spec_name:
        description: 'Specification name (optional for run_tests, required for infer_tests)'
        required: false
        type: string
      no_log:
        description: 'Skip writing log file for run_tests'
        required: false
        type: boolean
        default: false
  
  # Triggered on code changes
  pull_request:
    paths:
      - 'jobs/**/*.py'
      - 'jobs/**/*.yaml'
      - 'docs/**/*.md'
  
  push:
    paths:
      - 'jobs/**/*.py'
      - 'jobs/**/*.yaml'
    branches:
      - main

jobs:
  testing_agent:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml
      
      - name: Run tests (manual)
        if: github.event_name == 'workflow_dispatch' && inputs.action == 'run_tests'
        run: |
          if [ -n "${{ inputs.spec_name }}" ]; then
            if [ "${{ inputs.no_log }}" = "true" ]; then
              python tools/testing_agent.py run --spec "${{ inputs.spec_name }}" --no-log
            else
              python tools/testing_agent.py run --spec "${{ inputs.spec_name }}"
            fi
          else
            if [ "${{ inputs.no_log }}" = "true" ]; then
              python tools/testing_agent.py run --no-log
            else
              python tools/testing_agent.py run
            fi
          fi
      
      - name: Infer tests from specification
        if: github.event_name == 'workflow_dispatch' && inputs.action == 'infer_tests'
        run: |
          if [ -z "${{ inputs.spec_name }}" ]; then
            echo "Error: spec_name is required for infer_tests action"
            exit 1
          fi
          python tools/testing_agent.py infer "${{ inputs.spec_name }}"
      
      - name: List test logs
        if: github.event_name == 'workflow_dispatch' && inputs.action == 'list_logs'
        run: python tools/testing_agent.py logs
      
      - name: Auto-test on PR
        if: github.event_name == 'pull_request'
        run: |
          echo "Running tests on pull request..."
          python tools/testing_agent.py run --no-log
      
      - name: Auto-test on push to main
        if: github.event_name == 'push'
        run: |
          echo "Running tests after merge to main..."
          python tools/testing_agent.py run
      
      - name: Upload test logs
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && inputs.no_log != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: logs/tests_logs/*.log
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Commit test logs (on main branch)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add logs/tests_logs/
          if git diff --staged --quiet; then
            echo "No test logs to commit"
          else
            git commit -m "Add test logs from automated testing"
            git push
          fi
      
      - name: Test summary
        if: always()
        run: |
          echo ""
          echo "Testing Agent Workflow Complete"
          echo ""
          echo "Test results are available in the logs above."
          echo "For detailed logs, check the test-logs artifact or logs/tests_logs/ directory."
