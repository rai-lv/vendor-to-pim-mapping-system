job_id: mapping_method_training
glue_job_name: mapping_method_training
runtime: python_shell
entrypoint: glue_script.py

parameters:
  - JOB_NAME
  - vendor_name
  - prepared_input_key
  - prepared_output_prefix
  - INPUT_BUCKET
  - OUTPUT_BUCKET

inputs:
  - bucket: ${OUTPUT_BUCKET}
    key_pattern: ${prepared_output_prefix_norm}${vendor_name}_categoryMatchingProposals.json
    format: json
    required: true
  - bucket: ${OUTPUT_BUCKET}
    key_pattern: ${prepared_output_prefix_norm}${vendor_name}_categoryMatchingProposals_oneVendor_to_onePim_match.json
    format: json
    required: true
  - bucket: ${OUTPUT_BUCKET}
    key_pattern: ${prepared_output_prefix_norm}${vendor_name}_forMapping_products
    format: ndjson
    required: true
  - bucket: ${INPUT_BUCKET}
    key_pattern: canonical_mappings/Category_Mapping_Reference_*.json
    format: json
    required: true
  - bucket: ${INPUT_BUCKET}
    key_pattern: canonical_mappings/stable_training_sets/StableTrainingSet.json
    format: json
    required: true
  - bucket: ${INPUT_BUCKET}
    key_pattern: canonical_mappings/stable_training_sets/StableTrainingEvidence_Unigrams_v1.json
    format: json
    required: true
  - bucket: ${INPUT_BUCKET}
    key_pattern: canonical_mappings/stable_training_sets/StableTrainingEvidence_Pairs_v1.json
    format: json
    required: true

outputs:
  - bucket: ${OUTPUT_BUCKET}
    key_pattern: ${prepared_output_prefix_norm}mappingMethodTraining/run_receipts/run_receipt_${vendor_name}_${run_id}.json
    format: json
    required: true
  - bucket: ${OUTPUT_BUCKET}
    key_pattern: ${prepared_output_prefix_norm}mappingMethodTraining/stable_training_deltas/stable_training_delta_${vendor_name}_${run_id}.json
    format: json
    required: true
  - bucket: ${OUTPUT_BUCKET}
    key_pattern: ${prepared_output_prefix_norm}mappingMethodTraining/rules_snapshot/rules_snapshot_${vendor_name}_${run_id}.json
    format: json
    required: true
  - bucket: ${OUTPUT_BUCKET}
    key_pattern: ${prepared_output_prefix_norm}mappingMethodTraining/product_rule_hits/product_rule_hits_${vendor_name}_${run_id}.ndjson
    format: ndjson
    required: true
  - bucket: ${OUTPUT_BUCKET}
    key_pattern: ${prepared_output_prefix_norm}mappingMethodTraining/product_rule_hits/product_multimapping_exceptions_${vendor_name}_${run_id}.ndjson
    format: ndjson
    required: true
  - bucket: ${OUTPUT_BUCKET}
    key_pattern: ${prepared_output_prefix_norm}mappingMethodTraining/vendor_category_product_rule_hits/vendor_category_product_rule_hits_${vendor_name}_${run_id}.ndjson
    format: ndjson
    required: true
  - bucket: ${OUTPUT_BUCKET}
    key_pattern: ${prepared_output_prefix_norm}mappingMethodTraining/rule_validation_status/rule_validation_status_${vendor_name}_${run_id}.ndjson
    format: ndjson
    required: true
  - bucket: ${OUTPUT_BUCKET}
    key_pattern: ${prepared_output_prefix_norm}mappingMethodTraining/vendor_category_mapping_status/vendor_category_mapping_status_${vendor_name}_${run_id}.json
    format: json
    required: true
  - bucket: ${INPUT_BUCKET}
    key_pattern: canonical_mappings/stable_training_sets/StableTrainingEvidence_Unigrams_v1.json
    format: json
    required: true
  - bucket: ${INPUT_BUCKET}
    key_pattern: canonical_mappings/stable_training_sets/StableTrainingEvidence_Pairs_v1.json
    format: json
    required: true
  - bucket: ${INPUT_BUCKET}
    key_pattern: canonical_mappings/stable_training_sets/StableTrainingSet.json
    format: json
    required: true
  - bucket: ${INPUT_BUCKET}
    key_pattern: canonical_mappings/Category_Mapping_Reference_${new_suffix}.json
    format: json
    required: true

config_files:
  - bucket: ${INPUT_BUCKET}
    key_pattern: configuration-files/vendorInputProcessing_configs/categoryMapping_DenylistConfig.json
    format: json
    required: true
    repo_path: null

side_effects:
  deletes_inputs: false
  overwrites_outputs: true

logging_and_receipt:
  writes_run_receipt: true
  run_receipt_bucket: ${OUTPUT_BUCKET}
  run_receipt_key_pattern: ${prepared_output_prefix_norm}mappingMethodTraining/run_receipts/run_receipt_${vendor_name}_${run_id}.json
  counters_observed: TBD

notes:
  - "Evidence source: Analyzed glue_script.py, checked getResolvedOptions (required_args list), S3 I/O patterns including receipt writing, and boto3 put_object calls. No SparkContext or GlueContext usage detected, confirming python_shell runtime."
  - "Runtime-generated placeholders: ${run_id} is computed at runtime (not in parameters list), represents unique job run identifier. ${new_suffix} is dynamically generated for updated Category_Mapping_Reference files."
  - "prepared_output_prefix normalization: Script normalizes prefix to ensure proper S3 path structure, so manifest uses ${prepared_output_prefix_norm} placeholder."
  - "forMapping_products input: Script reads file without extension (line 2279: ${prepared_output_prefix}/${vendor_name}_forMapping_products). This matches the legacy output (no extension) written by category_mapping_to_canonical job, which writes both .ndjson and no-extension versions for backward compatibility."
  - "Outputs to INPUT_BUCKET: Some outputs (canonical mappings, training evidence, training sets) are written to INPUT_BUCKET to maintain shared reference data accessible to other jobs. These files serve dual roles as both inputs (read at job start) and outputs (updated/overwritten at job end), representing the job's update-in-place pattern for shared canonical references."
  - "Config file exists in S3 only (configuration-files/vendorInputProcessing_configs/), not mirrored in repository (verified: not in jobs/*/config/ or config/ directories)."
  - "counters_observed: TBD â€” Script writes run receipt with metadata but counter names are dynamic/internal. Need to review actual receipt structure to document emitted counter names."
